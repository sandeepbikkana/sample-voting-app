name: CI-CD Build, Push & Deploy to EKS

on:
  push:
    branches:
      - main
    paths:
      - '**/Dockerfile'
      #- '**/*.py'
      #- '**/*.js'
      #- 'k8s/**'

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️ Checkout Code
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 2️ Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️ Build Docker Images
      - name: Build Docker Images
        run: |
          IMAGE_TAG=${{ github.run_number }}
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/vote:$IMAGE_TAG ./vote
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/result:$IMAGE_TAG ./result
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/worker:$IMAGE_TAG ./worker

      # 4️ Login to DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5️ Push Docker Images
      - name: Push Images to DockerHub
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/vote:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/result:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/worker:${{ env.IMAGE_TAG }}

      # 6️ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 7️ Update kubeconfig for EKS
      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      # 8️ Deploy to EKS with kubectl
      - name: Deploy to EKS
        run: |
          kubectl set image deployment/vote vote=${{ secrets.DOCKERHUB_USERNAME }}/vote:${{ env.IMAGE_TAG }} -n default || kubectl apply -f k8s/
          kubectl set image deployment/result result=${{ secrets.DOCKERHUB_USERNAME }}/result:${{ env.IMAGE_TAG }} -n default || kubectl apply -f k8s/
          kubectl set image deployment/worker worker=${{ secrets.DOCKERHUB_USERNAME }}/worker:${{ env.IMAGE_TAG }} -n default || kubectl apply -f k8s/

          kubectl rollout status deployment/vote -n default
          kubectl rollout status deployment/result -n default
          kubectl rollout status deployment/worker -n default

      # 9️ Verify Pods
      - name: Verify Deployment
        run: kubectl get pods -o wide
